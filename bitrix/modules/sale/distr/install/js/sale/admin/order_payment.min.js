BX.namespace("BX.Sale.Admin.OrderPayment");BX.Sale.Admin.OrderPayment=function(e){this.clWindow=null;this.pdWindow=null;this.rtWindow=null;this.index=e.index;this.viewForm=!!e.viewForm;this.isAvailableChangeStatus=e.isAvailableChangeStatus;if(this.isAvailableChangeStatus){if(!!e.isPaid)this.initPaidPopup();else this.initNotPaidPopup()}this.initToggle();this.initReloadImg();this.initDeletePayment();var t=[];t["PAY_SYSTEM_LIST"]={callback:this.updatePaySystemList,context:this};BX.Sale.Admin.OrderEditPage.registerFieldsUpdaters(t);if(this.viewForm){var a=BX("ps_update");var i=BX("ID");if(i)i=i.value;var n=BX("PAYMENT_ID_"+this.index);if(n)n=n.value;if(a){BX.bind(a,"click",function(){var e={action:"updatePaySystemInfo",orderId:i,paymentId:n,callback:function(e){if(e.ERROR&&e.ERROR.length>0){alert(e.ERROR)}else{location.reload()}}};BX.Sale.Admin.OrderAjaxer.sendRequest(e)})}}};BX.Sale.Admin.OrderPayment.prototype.updatePaySystemList=function(e){var t=BX("PAY_SYSTEM_ID_"+this.index);if(!t)return;var a=t.options[t.selectedIndex].value;t.innerHTML=e;for(var i in t.options){if(t.options[i].value==a){t.options[i].selected=true;break}}this.reloadImg()};BX.Sale.Admin.OrderPayment.prototype.sendAjaxChangeStatus=function(e){var t=BX.ajax.prepareForm(BX(e.form_name));var a=BX("ID").value;var i=BX("PAYMENT_ID_"+this.index).value;var n={method:e.action,action:"updatePaymentStatus",orderId:a,paymentId:i,data:t.data,callback:e.callback};BX.Sale.Admin.OrderAjaxer.sendRequest(n)};BX.Sale.Admin.OrderPayment.prototype.initDeletePayment=function(){var e=BX("SECTION_"+this.index+"_DELETE");if(e)BX.bind(e,"click",BX.proxy(this.deletePayment,this))};BX.Sale.Admin.OrderPayment.prototype.initToggle=function(){var e=BX("PS_INFO_"+this.index);BX.bind(e,"click",this.togglePsInfo);e=BX("SECTION_"+this.index+"_TOGGLE");BX.bind(e,"click",BX.proxy(this.togglePayment,this))};BX.Sale.Admin.OrderPayment.prototype.initReloadImg=function(){this.obj=BX("PAY_SYSTEM_ID_"+this.index);BX.bind(this.obj,"change",BX.proxy(function(){if(BX.Sale.Admin.OrderEditPage.formId!="order_payment_edit_info_form"){BX.Sale.Admin.OrderAjaxer.sendRequest(BX.Sale.Admin.OrderEditPage.ajaxRequests.refreshOrderData())}this.reloadImg()},this))};BX.Sale.Admin.OrderPayment.prototype.deletePayment=function(){if(confirm(BX.message["PAYMENT_CONFIRM_DELETE"])){var e=BX("ID")?BX("ID").value:0;var t=BX("PAYMENT_ID_"+this.index)?BX("PAYMENT_ID_"+this.index).value:0;if(e>0&&t>0){var a={action:"deletePayment",orderId:BX("ID").value,paymentId:BX("PAYMENT_ID_"+this.index).value,callback:BX.proxy(function(e){if(e.ERROR&&e.ERROR.length>0){BX.Sale.Admin.OrderEditPage.showDialog(e.ERROR)}else{var t=BX.findParent(BX("payment_container_"+this.index),{tag:t});BX.cleanNode(t)}},this)};BX.Sale.Admin.OrderAjaxer.sendRequest(a)}else{var i=BX.findParent(BX("payment_container_"+this.index),{tag:i});BX.cleanNode(i)}}};BX.Sale.Admin.OrderPayment.prototype.togglePsInfo=function(){var e=BX.nextSibling(this);var t=e.style.display=="none";if(t){e.style.display="table";BX.html(this,BX.message["PAYMENT_TOGGLE_UP"])}else{BX.hide(e);BX.html(this,BX.message["PAYMENT_TOGGLE_DOWN"])}};BX.Sale.Admin.OrderPayment.prototype.togglePayment=function(){BX.toggle(BX("SECTION_"+this.index));BX.toggle(BX("SECTION_SHORT_"+this.index));var e=BX("SECTION_"+this.index).style.display=="none";BX.html(BX("SECTION_"+this.index+"_TOGGLE"),BX.message["PAYMENT_TOGGLE_"+(e?"DOWN":"UP")])};BX.Sale.Admin.OrderPayment.prototype.reloadImg=function(){var e=BX("LOGOTIP_"+this.index);e.src=logoList[BX(this.obj).value]};BX.Sale.Admin.OrderPayment.prototype.showReturnWindow=function(e){var t='<table width="100%" class="adm-detail-content-table edit-table">';t+="<tbody>";if(e=="return"){t+='<tr><td class="adm-detail-content-cell-l fwb">'+BX.message["PAYMENT_OPERATION_TITLE"]+':</td><td class="adm-detail-content-cell-r">';t+='<select name="PAY_RETURN_OPERATION_ID_'+this.index+'" id="PAY_OPERATION_ID_'+this.index+'" class="adm-bus-select">';t+='<option value="RETURN">'+BX.message["PAYMENT_OPERATION_RETURN"]+"</option>";t+="</select></td></tr><tr>";t+='<td class="adm-detail-content-cell-l fwb" width="40%">'+BX.message["PAYMENT_RETURN_NUM_DOC"]+":</td>";t+='<td class="adm-detail-content-cell-r tal"><input type="text" class="adm-bus-input" value="" name="PAY_RETURN_NUM_'+this.index+'" id="PAY_RETURN_NUM_'+this.index+'" maxlength="20">';t+="</td></tr>";t+='<td class="adm-detail-content-cell-l fwb" width="40%">'+BX.message["PAYMENT_RETURN_DATE"]+":</td>";t+='<td class="adm-detail-content-cell-r tal"><div class="adm-input-wrap adm-calendar-second" style="display: inline-block;">';t+='<input type="text" class="adm-input adm-calendar-to" id="PAY_RETURN_DATE_'+this.index+'" name="PAY_RETURN_DATE_'+this.index+'" size="15" value="">';t+='<span class="adm-calendar-icon" title="'+BX.message["PAYMENT_RETURN_DATE_ALT"]+'" onclick="BX.calendar({node:this, field:\'PAY_RETURN_DATE_'+this.index+"', form: '', bTime: false, bHideTime: false});\"></span>";t+="</div></td></tr><tr>";t+='<td class="adm-detail-content-cell-l fwb">'+BX.message["PAYMENT_RETURN_COMMENT"]+':</td><td class="adm-detail-content-cell-r"><div><textarea class="adm-bus-textarea" name="PAY_RETURN_COMMENT_'+this.index+'" id="PAY_RETURN_COMMENT_'+this.index+'"></textarea></div></td>';t+="</tr><tr>"}else{t+="<tr>";t+='<td class="adm-detail-content-cell-l fwb">'+BX.message["PAYMENT_RETURN_COMMENT"]+':</td><td class="adm-detail-content-cell-r"><div><textarea class="adm-bus-textarea" name="PAY_RETURN_COMMENT_'+this.index+'" id="PAY_RETURN_COMMENT_'+this.index+'"></textarea></div></td>';t+="</tr>"}t+="</tbody></table>";if(!this.rtWindow&&e=="return"){this.rtWindow=new BX.CDialog({content:'<form id="payment_return_form_'+this.index+'" name="payment_return_form_'+this.index+'">'+t+"</form>",title:BX.message["PAYMENT_WINDOW_RETURN_TITLE"],width:650,height:250,resizable:false,buttons:[new BX.CWindowButton({title:BX.message["PAYMENT_WINDOW_RETURN_BUTTON_SAVE"],action:BX.proxy(function(){var e={index:this.index,action:"return",form_name:"payment_return_form_"+this.index,callback:BX.proxy(function(e){if(e.ERROR&&e.ERROR.length>0){BX.Sale.Admin.OrderEditPage.showDialog(e.ERROR)}else{this.changeNotPaidStatus("NO");this.initNotPaidPopup();BX.Sale.Admin.OrderEditPage.callFieldsUpdaters(e.RESULT)}},this)};this.sendAjaxChangeStatus(e);BX.WindowManager.Get().Close()},this),className:"adm-btn-save"}),BX.CDialog.btnCancel]})}else if(!this.clWindow&&e=="cancel"){this.clWindow=new BX.CDialog({content:'<form id="payment_cancel_form_'+this.index+'" name="payment_cancel_form_'+this.index+'">'+t+"</form>",title:BX.message["PAYMENT_WINDOW_CANCEL_TITLE"],width:650,height:100,resizable:false,buttons:[new BX.CWindowButton({title:BX.message["PAYMENT_WINDOW_RETURN_BUTTON_SAVE"],action:BX.proxy(function(){var e={index:this.index,action:"cancel",form_name:"payment_cancel_form_"+this.index,callback:BX.proxy(function(e){if(e.ERROR&&e.ERROR.length>0){BX.Sale.Admin.OrderEditPage.showDialog(e.ERROR)}else{this.changeNotPaidStatus("NO");this.initNotPaidPopup();BX.Sale.Admin.OrderEditPage.callFieldsUpdaters(e.RESULT)}},this)};this.sendAjaxChangeStatus(e);BX.WindowManager.Get().Close()},this),className:"adm-btn-save"}),BX.CDialog.btnCancel]})}if(e=="return")this.rtWindow.Show();else this.clWindow.Show()};BX.Sale.Admin.OrderPayment.prototype.showWindowPaidPayment=function(){if(!this.pdWindow){var e=BX("AUTO_CHANGE_STATUS_ON_PAID");var t="";if(e&&e.value=="N"){var a=BX("STATUS_ID");var i=BX.findChildren(a,{tag:"option"});t+='<tr><td class="adm-detail-content-cell-l fwb" width="40%">'+BX.message["PAYMENT_ORDER_STATUS"]+":</td>";t+='<td class="adm-detail-content-cell-r tal"><select name="ORDER_STATUS_ID_'+this.index+'" id="ORDER_STATUS_ID_'+this.index+'">';for(var n in i)t+=i[n].outerHTML;t+="</select></td></tr>";var d=this.index;BX.Sale.Admin.OrderEditPage.registerFieldsUpdaters({STATUS_ID:{callback:function(e){BX("ORDER_STATUS_ID_"+d).value=e},context:this}})}var s='<table width="100%" class="adm-detail-content-table edit-table">';s+="<tbody>";s+="<tr>";s+='<td class="adm-detail-content-cell-l fwb" width="40%">'+BX.message["PAYMENT_PAY_VOUCHER_DATE"]+":</td>";s+='<td class="adm-detail-content-cell-r tal"><div class="adm-input-wrap adm-calendar-second" style="display: inline-block;">';s+='<input type="text" class="adm-input adm-calendar-to" id="PAY_VOUCHER_DATE_'+this.index+'" name="PAY_VOUCHER_DATE_'+this.index+'" size="15" value="">';s+='<span class="adm-calendar-icon" title="'+BX.message["PAYMENT_RETURN_DATE_ALT"]+'" onclick="BX.calendar({node:this, field:\'PAY_VOUCHER_DATE_'+this.index+"', form: '', bTime: false, bHideTime: false});\"></span>";s+="</div></td></tr><tr>";s+='<td class="adm-detail-content-cell-l fwb" width="40%">'+BX.message["PAYMENT_PAY_VOUCHER_NUM"]+":</td>";s+='<td class="adm-detail-content-cell-r tal"><input type="text" class="adm-bus-input" value="" name="PAY_VOUCHER_NUM_'+this.index+'" id="PAY_VOUCHER_NUM_'+this.index+'" maxlength="20">';s+="</td></tr>";s+=t;s+="</tbody></table>";this.pdWindow=new BX.CDialog({content:'<form id="payment_voucher_form_'+this.index+'" name="order_new_table_settings_'+this.index+'">'+s+"</form>",title:BX.message["PAYMENT_WINDOW_VOUCHER_TITLE"],width:650,height:200,resizable:false,buttons:[new BX.CWindowButton({title:BX.message["PAYMENT_WINDOW_RETURN_BUTTON_SAVE"],action:BX.proxy(function(){var e={index:this.index,action:"save",form_name:"payment_voucher_form_"+this.index,callback:BX.proxy(function(e){if(e.ERROR&&e.ERROR.length>0){BX.Sale.Admin.OrderEditPage.showDialog(e.ERROR)}else{this.changePaidStatus("YES");this.initPaidPopup();BX.Sale.Admin.OrderEditPage.callFieldsUpdaters(e.RESULT)}},this)};this.sendAjaxChangeStatus(e);BX.WindowManager.Get().Close()},this),className:"adm-btn-save"}),BX.CDialog.btnCancel]})}this.pdWindow.Show()};BX.Sale.Admin.OrderPayment.prototype.changeNotPaidStatus=function(e){var t=BX("BUTTON_PAID_"+this.index);var a=BX("BUTTON_PAID_"+this.index+"_SHORT");if(t){BX.html(t,BX.message("PAYMENT_PAID_"+e));BX.addClass(t,"notpay")}if(a){BX.html(a,BX.message("PAYMENT_PAID_"+e));BX.addClass(a,"notpay")}};BX.Sale.Admin.OrderPayment.prototype.changePaidStatus=function(e){var t=BX("BUTTON_PAID_"+this.index);var a=BX("BUTTON_PAID_"+this.index+"_SHORT");if(t){BX.html(t,BX.message("PAYMENT_PAID_"+e));BX.removeClass(t,"notpay")}if(a){BX.html(a,BX.message("PAYMENT_PAID_"+e));BX.removeClass(a,"notpay")}};BX.Sale.Admin.OrderPayment.prototype.initNotPaidPopup=function(){var e=[this.index];if(this.viewForm)e.push(this.index+"_SHORT");var t=BX("BUTTON_PAID_"+this.index);var a=BX("BUTTON_PAID_"+this.index+"_SHORT");for(var i in e){var n=[{ID:"PAID",TEXT:BX.message("PAYMENT_PAID_YES"),ONCLICK:BX.proxy(function(){if(this.viewForm){this.showWindowPaidPayment()}else{BX("PAYMENT_PAID_"+e[i]).value="Y";this.changePaidStatus("YES")}},this)}];if(!this.viewForm){n.unshift({ID:"NOT_PAID",TEXT:BX.message("PAYMENT_PAID_NO"),ONCLICK:BX.proxy(function(){this.changeNotPaidStatus("NO");BX("PAYMENT_PAID_"+e[i]).value="N"},this)})}var d=new BX.COpener({DIV:BX("BUTTON_PAID_"+e[i]).parentNode,MENU:n})}};BX.Sale.Admin.OrderPayment.prototype.initPaidPopup=function(){var e=BX.findChildrenByClassName(BX("PAYMENT_BLOCK_STATUS_INFO_"+this.index),"not_paid",true);var t=BX.findChildrenByClassName(BX("PAYMENT_BLOCK_STATUS_INFO_"+this.index),"return",true);var a=[this.index];if(this.viewForm)a.push(this.index+"_SHORT");var i=BX("BUTTON_PAID_"+this.index);var n=BX("BUTTON_PAID_"+this.index+"_SHORT");var d=[{ID:"CANCEL",TEXT:BX.message("PAYMENT_PAID_CANCEL"),ONCLICK:BX.proxy(function(){if(this.viewForm){this.showReturnWindow("cancel")}else{var i=BX("PAYMENT_PAID_"+a[s]);if(i)i.value="N";var n=BX("PAYMENT_IS_RETURN_"+a[s]);if(n)n.value="N";var d=BX("OPERATION_ID_"+this.index);if(d)d.options[d.selectedIndex].value="";this.changeNotPaidStatus("NO");for(var r in e)BX.style(e[r],"display","table-row");for(var r in t)BX.style(t[r],"display","none")}},this)},{ID:"RETURN",TEXT:BX.message("PAYMENT_PAID_RETURN"),ONCLICK:BX.proxy(function(){if(this.viewForm){this.showReturnWindow("return")}else{if(BX("PAYMENT_PAID_"+a[s]))BX("PAYMENT_PAID_"+a[s]).value="N";var i=BX("PAYMENT_IS_RETURN_"+a[s]);if(i)i.value="Y";this.changeNotPaidStatus("NO");for(var n in e)BX.style(e[n],"display","table-row");for(var n in t)BX.style(t[n],"display","table-row")}},this)}];if(!this.viewForm){d.unshift({ID:"PAID",TEXT:BX.message("PAYMENT_PAID_YES"),ONCLICK:BX.proxy(function(){if(this.viewForm){this.showWindowPaidPayment()}else{var i=BX("PAYMENT_PAID_"+a[s]);if(i)i.value="Y";var n=BX("OPERATION_ID_"+this.index);if(n)n.options[n.selectedIndex].value="";for(var d in e)BX.style(e[d],"display","none");for(var d in t)BX.style(t[d],"display","none")}},this)})}for(var s in a){var r=new BX.COpener({DIV:BX("BUTTON_PAID_"+a[s]).parentNode,MENU:d})}};BX.Sale.Admin.OrderPayment.prototype.setPrice=function(e){var t=BX("PAYMENT_SUM_1");if(t)t.value=parseFloat(e).toFixed(2)};BX.Sale.Admin.OrderPayment.prototype.getCreateOrderFieldsUpdaters=function(){return{PRICE:BX.Sale.Admin.OrderPayment.prototype.setPrice}};BX.namespace("BX.Sale.Admin.GeneralPayment");BX.Sale.Admin.GeneralPayment={addNewPayment:function(e,t){var a=BX("ID");if(t=="edit"){var i=BX.findParent(e,{tag:"div"});var n=BX.findChildrenByClassName(i,"adm-bus-pay",true);var d=BX.Sale.Admin.OrderEditPage.getAllFormData();var s={method:"POST",action:"createNewPayment",index:parseInt(n.length)+1,formData:d,callback:function(t){var a=BX.processHTML(t.PAYMENT);var n=BX.create("div");n.innerHTML=a["HTML"];i.insertBefore(n,e);BX.evalGlobal(a["SCRIPT"][0]["JS"]);BX.Sale.Admin.OrderEditPage.unRegisterFieldUpdater("PRICE",BX.Sale.Admin.OrderPayment.prototype.setPrice)}};BX.Sale.Admin.OrderAjaxer.sendRequest(s)}else{window.location="sale_order_payment_edit.php?lang="+BX.Sale.Admin.OrderEditPage.languageId+"&order_id="+a.value+"&backurl="+encodeURIComponent(window.location.pathname+window.location.search)}},useCurrentBudget:function(e){var t=BX("PAYMENT_INNER_BUDGET_ID");var a=BX("PAY_SYSTEM_ID_1");a.value=t.value;var i=BX("LOGOTIP_1");i.src=logoList[t.value];var n=BX("sale-order-financeinfo-payable");var d=BX("sale-order-financeinfo-user-budget-input");var s=parseFloat(n.value);var r=parseFloat(d.value);var l=s;if(r<s){l=r}BX.Sale.Admin.OrderPayment.prototype.setPrice(l);BX.Sale.Admin.OrderEditPage.showDialog(BX.message["PAYMENT_USE_INNER_BUDGET"]);BX.hide(e)}};
//# sourceMappingURL=order_payment.map.js